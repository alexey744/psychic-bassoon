<!DOCTYPE html>
<!-- saved from url=(0066)file:///C:/Users/Home/Desktop/%D1%81%D0%B0%D0%B9%D1%822/index.html -->
<html lang="ru"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1">
<title>–ñ—É—Ä–Ω–∞–ª –æ—Ü–µ–Ω–æ–∫ —Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –∏ –≥—Ä–∞—Ñ–∏–∫–∞–º–∏</title>
<style>
  /* –°—Ç–∏–ª–∏ —É–ø—Ä–æ—â–µ–Ω—ã –∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω—ã */
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f5f7fa;
    margin: 0; padding: 0;
    color: #333;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  .tab-buttons {
    display: flex;
    background-color: #2c3e50;
  }
  .tab-buttons button {
    flex: 1;
    padding: 14px 0;
    border: none;
    background: transparent;
    color: #ecf0f1;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: background-color 0.3s, color 0.3s;
  }
  .tab-buttons button:hover {
    background-color: #34495e;
  }
  .tab-buttons button.active {
    border-bottom: 3px solid #e67e22;
    color: #e67e22;
    background-color: #34495e;
  }
  .tab {
    display: none;
    max-width: 960px;
    margin: 20px auto 40px;
    background: white;
    padding: 25px 30px;
    border-radius: 10px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
  }
  .tab.active-tab {
    display: block;
  }
  h3 {
    margin-top: 0;
    color: #2c3e50;
    font-weight: 700;
  }
  button.action-btn {
    background-color: #e67e22;
    border: none;
    color: white;
    padding: 12px 20px;
    margin: 8px 8px 8px 0;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s;
    user-select: none;
  }
  button.action-btn:hover {
    background-color: #d35400;
  }
  input[type="text"], input[type="number"], input[type="file"], select {
    padding: 10px 12px;
    margin: 8px 12px 16px 0;
    border: 1.8px solid #ccc;
    border-radius: 6px;
    font-size: 1rem;
    width: 220px;
    transition: border-color 0.3s;
  }
  input[type="text"]:focus, input[type="number"]:focus, input[type="file"]:focus, select:focus {
    border-color: #e67e22;
    outline: none;
  }
  label {
    font-weight: 600;
    margin-right: 6px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    font-size: 0.95rem;
  }
  th, td {
    padding: 10px 12px;
    border: 1px solid #ddd;
    text-align: left;
  }
  th {
    background-color: #e67e22;
    color: white;
    font-weight: 700;
  }
  tr:nth-child(even) {
    background-color: #f9f9f9;
  }
  tr:hover {
    background-color: #ffe6cc;
  }
  .table-btn {
    background: #3498db;
    border: none;
    color: white;
    padding: 6px 10px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9rem;
    margin-right: 6px;
    transition: background-color 0.3s;
  }
  .table-btn:hover {
    background: #2980b9;
  }
  .table-btn.delete {
    background: #e74c3c;
  }
  .table-btn.delete:hover {
    background: #c0392b;
  }
  #help p, #about p {
    line-height: 1.5;
    font-size: 1rem;
  }
  #about img {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    margin-bottom: 15px;
  }
  .chart-container {
    margin-top: 30px;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    background: #fff;
  }
  canvas {
    max-width: 100%;
    height: 300px !important;
  }
  @media (max-width: 700px) {
    input[type="text"], input[type="number"], input[type="file"], select {
      width: 100%;
      margin-bottom: 12px;
    }
    .tab-buttons button {
      font-size: 0.9rem;
      padding: 10px 0;
    }
  }
</style>
</head>
<body>

<div class="tab-buttons" role="tablist" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º">
  <button class="active" onclick="showTab(&#39;upload&#39;)" role="tab" aria-selected="true" aria-controls="upload" id="tab-upload">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ü–µ–Ω–æ–∫</button>
  <button onclick="showTab(&#39;journal&#39;)" role="tab" aria-selected="false" aria-controls="journal" id="tab-journal">–ñ—É—Ä–Ω–∞–ª</button>
  <button onclick="showTab(&#39;stats&#39;)" role="tab" aria-selected="false" aria-controls="stats" id="tab-stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
  <button onclick="showTab(&#39;charts&#39;)" role="tab" aria-selected="false" aria-controls="charts" id="tab-charts">–ì—Ä–∞—Ñ–∏–∫–∏</button>
  <button onclick="showTab(&#39;help&#39;)" role="tab" aria-selected="false" aria-controls="help" id="tab-help">–ü–æ–º–æ—â—å</button>
  <button onclick="showTab(&#39;about&#39;)" role="tab" aria-selected="false" aria-controls="about" id="tab-about">–û –ø—Ä–æ–≥—Ä–∞–º–º–µ</button>
</div>

<!-- –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ü–µ–Ω–æ–∫ -->
<div id="upload" class="tab active-tab" role="tabpanel" aria-labelledby="tab-upload">
  <h3>–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ü–µ–Ω–æ–∫ –∏–∑ —Ñ–∞–π–ª–∞</h3>
  <p>–§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞: <code>–§–ò–û,–ö–ª–∞—Å—Å,–ü—Ä–µ–¥–º–µ—Ç,–û—Ü–µ–Ω–∫–∞</code> (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω,9–ê,–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞,5)</p>
  <input type="file" id="fileInput" accept=".csv,.txt" aria-label="–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ü–µ–Ω–æ–∫ (.csv, .txt)">
  <div id="uploadTable" aria-live="polite" style="margin-top: 20px;"><p>–î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.</p></div>
</div>

<!-- –ñ—É—Ä–Ω–∞–ª -->
<div id="journal" class="tab" role="tabpanel" aria-labelledby="tab-journal">
  <h3>–°–æ–∑–¥–∞–Ω–∏–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–∞</h3>
  <div>
    <input type="text" id="fio" placeholder="–§–ò–û —É—á–µ–Ω–∏–∫–∞" aria-label="–§–ò–û —É—á–µ–Ω–∏–∫–∞">
    <input type="text" id="className" placeholder="–ö–ª–∞—Å—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, 9–ê)" aria-label="–ö–ª–∞—Å—Å —É—á–µ–Ω–∏–∫–∞">
    <input type="text" id="subject" placeholder="–ü—Ä–µ–¥–º–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞)" aria-label="–ü—Ä–µ–¥–º–µ—Ç">
    <input type="number" id="grade" placeholder="–û—Ü–µ–Ω–∫–∞ (1-5)" min="1" max="5" aria-label="–û—Ü–µ–Ω–∫–∞ —É—á–µ–Ω–∏–∫–∞">
    <button class="action-btn" onclick="addOrUpdateStudent()">–î–æ–±–∞–≤–∏—Ç—å / –û–±–Ω–æ–≤–∏—Ç—å</button>
    <button class="action-btn" onclick="downloadJournalTXT()">–°–∫–∞—á–∞—Ç—å TXT</button>
    <button class="action-btn" onclick="downloadJournalCSV()">–°–∫–∞—á–∞—Ç—å CSV</button>
    <button class="action-btn" onclick="downloadJournalXLSX()">–°–∫–∞—á–∞—Ç—å XLSX</button>
  </div>
  <div>
    <label for="filterClass">–§–∏–ª—å—Ç—Ä –ø–æ –∫–ª–∞—Å—Å—É:</label>
    <select id="filterClass" onchange="renderJournalTable()"><option value="all">–í—Å–µ –∫–ª–∞—Å—Å—ã</option></select>
    <label for="filterSubject">–§–∏–ª—å—Ç—Ä –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É:</label>
    <select id="filterSubject" onchange="renderJournalTable()"><option value="all">–í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã</option></select>
  </div>
  <div id="journalTable" aria-live="polite" style="margin-top: 20px;"><p>–ó–∞–ø–∏—Å–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p></div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div id="stats" class="tab" role="tabpanel" aria-labelledby="tab-stats">
  <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —Ç–∞–±–ª–∏—á–Ω–æ–º –≤–∏–¥–µ</h3>
  <div>
    <label for="statsClass">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å:</label>
    <select id="statsClass" onchange="renderStats()"><option value="all">–í—Å–µ –∫–ª–∞—Å—Å—ã</option></select>
    <label for="statsSubject">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç:</label>
    <select id="statsSubject" onchange="renderStats()"><option value="all">–í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã</option></select>
  </div>
  <div id="statsOutput" aria-live="polite" style="margin-top: 15px;"></div>
</div>

<!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
<div id="charts" class="tab" role="tabpanel" aria-labelledby="tab-charts">
  <h3>–ì—Ä–∞—Ñ–∏–∫–∏ –ø–æ –≤—Å–µ–º –ø—Ä–µ–¥–º–µ—Ç–∞–º –∏ —É—á–µ–Ω–∏–∫–∞–º</h3>
  <div id="chartsContainer" style="margin-top:20px;"></div>
</div>

<!-- –ü–æ–º–æ—â—å -->
<div id="help" class="tab" role="tabpanel" aria-labelledby="tab-help">
  <h3>–ü–æ–º–æ—â—å</h3>
  <p><strong>–ü–æ –≤–æ–ø—Ä–æ—Å–∞–º, —Å–≤—è–∑–∞–Ω–Ω—ã–º —Å —Å–∞–π—Ç–æ–º, –æ–±—Ä–∞—â–∞—Ç—å—Å—è –Ω–∞ –ø–æ—á—Ç—É:</strong> <a href="mailto:alekhan@gmail.com">alekhan@gmail.com</a></p>
  <p><strong>–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ü–µ–Ω–æ–∫:</strong> –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ü–µ–Ω–∫–∏ –∏–∑ —Ñ–∞–π–ª–∞. –§–æ—Ä–º–∞—Ç –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏: <code>–§–ò–û,–ö–ª–∞—Å—Å,–ü—Ä–µ–¥–º–µ—Ç,–û—Ü–µ–Ω–∫–∞</code>. –û—Ü–µ–Ω–∫–∞ - —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 5.</p>
  <p><strong>–ñ—É—Ä–Ω–∞–ª:</strong> –°–æ–∑–¥–∞–≤–∞–π—Ç–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∏ —É–¥–∞–ª—è–π—Ç–µ –∑–∞–ø–∏—Å–∏ —É—á–µ–Ω–∏–∫–æ–≤. –ú–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∂—É—Ä–Ω–∞–ª.</p>
  <p><strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong> –í—ã–≤–æ–¥–∏—Ç —Ç–∞–±–ª–∏—Ü—É —Å –ø–æ–¥—Å—á—ë—Ç–æ–º —Å—Ä–µ–¥–Ω–µ–π –æ—Ü–µ–Ω–∫–∏, –º–µ–¥–∏–∞–Ω—ã, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∏ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º –æ—Ü–µ–Ω–æ–∫ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –∫–ª–∞—Å—Å—É –∏ –ø—Ä–µ–¥–º–µ—Ç—É –∏–ª–∏ –ø–æ –≤—Å–µ–º.</p>
  <p><strong>–ì—Ä–∞—Ñ–∏–∫–∏:</strong> –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞ —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —Å—Ä–µ–¥–Ω–µ–π –æ—Ü–µ–Ω–∫–∏ –∫–∞–∂–¥–æ–≥–æ —É—á–µ–Ω–∏–∫–∞.</p>
  <p><strong>–û –ø—Ä–æ–≥—Ä–∞–º–º–µ:</strong> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–µ –∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã.</p>
</div>

<!-- –û –ø—Ä–æ–≥—Ä–∞–º–º–µ -->
<div id="about" class="tab" role="tabpanel" aria-labelledby="tab-about">
  <h3>–û –ø—Ä–æ–≥—Ä–∞–º–º–µ</h3>
  <img src="./–ñ—É—Ä–Ω–∞–ª –æ—Ü–µ–Ω–æ–∫ —Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –∏ –≥—Ä–∞—Ñ–∏–∫–∞–º–∏_files/756adb8647bb23fa271bf7cdc99e8bc3.jpg" alt="–§–æ—Ç–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞">
  <p><strong>–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫:</strong> –ê.–í.–ì—Ä–µ—á–∏—à–Ω–∏–∫–æ–≤</p>
  <p><strong>–ö–æ–Ω—Ç–∞–∫—Ç—ã:</strong> <a href="mailto:alekhan@gmail.com">alekhan@gmail.com</a></p>
</div>

<script src="./–ñ—É—Ä–Ω–∞–ª –æ—Ü–µ–Ω–æ–∫ —Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –∏ –≥—Ä–∞—Ñ–∏–∫–∞–º–∏_files/chart.js.–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"></script>
<script>
  let students = [];
  let editIndex = -1;
  let chartInstances = [];

  // --- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–∫–ª–∞–¥–∫–∞–º ---
  function showTab(tabId) {
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active-tab'));
    document.getElementById(tabId).classList.add('active-tab');
    document.querySelectorAll('.tab-buttons button').forEach(btn => {
      btn.classList.remove('active');
      btn.setAttribute('aria-selected', 'false');
    });
    const activeBtn = document.querySelector(`.tab-buttons button[onclick="showTab('${tabId}')"]`);
    if(activeBtn) {
      activeBtn.classList.add('active');
      activeBtn.setAttribute('aria-selected', 'true');
      activeBtn.focus();
    }
    if(tabId === 'stats') renderStats();
    if(tabId === 'charts') renderAllSubjectCharts();
  }

  // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---
  function escapeHTML(str) {
    return String(str).replace(/[&<>"']/g, function(m) {
      return ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[m];
    });
  }

  // –ü–∞—Ä—Å–∏–º CSV –∏–ª–∏ TXT —Å –æ—Ü–µ–Ω–∫–∞–º–∏
  function parseCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    const data = [];
    for(let line of lines) {
      const parts = line.split(',');
      if(parts.length >= 4) {
        const fio = parts[0].trim();
        const className = parts[1].trim();
        const subject = parts[2].trim();
        const grade = parseInt(parts[3].trim());
        if(fio && className && subject && !isNaN(grade) && grade >= 1 && grade <= 5) {
          data.push({fio, className, subject, grade});
        }
      }
    }
    return data;
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
  document.getElementById('fileInput').addEventListener('change', e => {
    const file = e.target.files[0];
    if(!file) return;
    const ext = file.name.split('.').pop().toLowerCase();
    if(!['csv','txt'].includes(ext)) {
      alert('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã .csv –∏ .txt');
      e.target.value = '';
      return;
    }
    const reader = new FileReader();
    reader.onload = evt => {
      try {
        const data = parseCSV(evt.target.result);
        if(data.length === 0) {
          alert('–§–∞–π–ª –ø—É—Å—Ç–æ–π –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.');
          return;
        }
        students = [];
        data.forEach(rec => {
          const existing = students.find(s => s.fio === rec.fio && s.className === rec.className && s.subject === rec.subject);
          if(existing) {
            existing.grade = rec.grade;
          } else {
            students.push({...rec});
          }
        });
        editIndex = -1;
        updateFilters();
        renderUploadTable();
        renderJournalTable();
        alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!');
      } catch {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞.');
      }
    };
    reader.readAsText(file);
  });

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ —Å–µ–ª–µ–∫—Ç–æ–≤
  function updateFilters() {
    const classes = Array.from(new Set(students.map(s => s.className))).sort();
    const subjects = Array.from(new Set(students.map(s => s.subject))).sort();

    ['filterClass','statsClass'].forEach(id => {
      const select = document.getElementById(id);
      if(!select) return;
      const currentValue = select.value;
      select.innerHTML = '<option value="all">–í—Å–µ –∫–ª–∞—Å—Å—ã</option>';
      classes.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        select.appendChild(opt);
      });
      if(classes.includes(currentValue)) select.value = currentValue;
    });

    ['filterSubject','statsSubject'].forEach(id => {
      const select = document.getElementById(id);
      if(!select) return;
      const currentValue = select.value;
      select.innerHTML = '<option value="all">–í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã</option>';
      subjects.forEach(subj => {
        const opt = document.createElement('option');
        opt.value = subj;
        opt.textContent = subj;
        select.appendChild(opt);
      });
      if(subjects.includes(currentValue)) select.value = currentValue;
    });
  }

  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –æ—Ü–µ–Ω–æ–∫
  function renderUploadTable() {
    if(students.length === 0) {
      document.getElementById('uploadTable').innerHTML = '<p>–î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.</p>';
      return;
    }
    let html = `<table aria-label="–¢–∞–±–ª–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –æ—Ü–µ–Ω–æ–∫"><thead><tr><th>–§–ò–û</th><th>–ö–ª–∞—Å—Å</th><th>–ü—Ä–µ–¥–º–µ—Ç</th><th>–û—Ü–µ–Ω–∫–∞</th></tr></thead><tbody>`;
    for(let s of students) {
      html += `<tr><td>${escapeHTML(s.fio)}</td><td>${escapeHTML(s.className)}</td><td>${escapeHTML(s.subject)}</td><td>${s.grade}</td></tr>`;
    }
    html += '</tbody></table>';
    document.getElementById('uploadTable').innerHTML = html;
  }

  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –∂—É—Ä–Ω–∞–ª–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
  function renderJournalTable() {
    const filterClass = document.getElementById('filterClass').value;
    const filterSubject = document.getElementById('filterSubject').value;
    let filtered = students;
    if(filterClass !== 'all') filtered = filtered.filter(s => s.className === filterClass);
    if(filterSubject !== 'all') filtered = filtered.filter(s => s.subject === filterSubject);
    if(filtered.length === 0) {
      document.getElementById('journalTable').innerHTML = '<p>–ó–∞–ø–∏—Å–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>';
      return;
    }
    let html = `<table aria-label="–¢–∞–±–ª–∏—Ü–∞ –∂—É—Ä–Ω–∞–ª–∞ –æ—Ü–µ–Ω–æ–∫"><thead><tr><th>–§–ò–û</th><th>–ö–ª–∞—Å—Å</th><th>–ü—Ä–µ–¥–º–µ—Ç</th><th>–û—Ü–µ–Ω–∫–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>`;
    filtered.forEach((s) => {
      const realIndex = students.indexOf(s);
      html += `<tr>
        <td>${escapeHTML(s.fio)}</td>
        <td>${escapeHTML(s.className)}</td>
        <td>${escapeHTML(s.subject)}</td>
        <td>${s.grade}</td>
        <td>
          <button class="table-btn" aria-label="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ${escapeHTML(s.fio)}" onclick="editStudent(${realIndex})">‚úé</button>
          <button class="table-btn delete" aria-label="–£–¥–∞–ª–∏—Ç—å ${escapeHTML(s.fio)}" onclick="deleteStudent(${realIndex})">üóë</button>
        </td>
      </tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('journalTable').innerHTML = html;
  }

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
  function addOrUpdateStudent() {
    const fioInput = document.getElementById('fio');
    const classInput = document.getElementById('className');
    const subjectInput = document.getElementById('subject');
    const gradeInput = document.getElementById('grade');
    const fio = fioInput.value.trim();
    const className = classInput.value.trim();
    const subject = subjectInput.value.trim();
    const grade = parseInt(gradeInput.value);
    if(fio.length < 3) {
      alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –§–ò–û (–Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤).');
      fioInput.focus();
      return;
    }
    if(className.length < 1) {
      alert('–í–≤–µ–¥–∏—Ç–µ –∫–ª–∞—Å—Å —É—á–µ–Ω–∏–∫–∞.');
      classInput.focus();
      return;
    }
    if(subject.length < 1) {
      alert('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç.');
      subjectInput.focus();
      return;
    }
    if(isNaN(grade) || grade < 1 || grade > 5) {
      alert('–û—Ü–µ–Ω–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º –æ—Ç 1 –¥–æ 5.');
      gradeInput.focus();
      return;
    }
    if(editIndex >= 0) {
      students[editIndex] = {fio, className, subject, grade};
      editIndex = -1;
    } else {
      students.push({fio, className, subject, grade});
    }
    fioInput.value = '';
    classInput.value = '';
    subjectInput.value = '';
    gradeInput.value = '';
    updateFilters();
    renderJournalTable();
    renderUploadTable();
    alert('–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
  }

  // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏
  function editStudent(index) {
    if(index < 0 || index >= students.length) return;
    editIndex = index;
    const student = students[index];
    document.getElementById('fio').value = student.fio;
    document.getElementById('className').value = student.className;
    document.getElementById('subject').value = student.subject;
    document.getElementById('grade').value = student.grade;
  }

  // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
  function deleteStudent(index) {
    if(index < 0 || index >= students.length) return;
    if(confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) {
      students.splice(index, 1);
      editIndex = -1;
      updateFilters();
      renderJournalTable();
      renderUploadTable();
    }
  }

  // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞ ---
  function downloadJournalTXT() {
    if(students.length === 0) {
      alert('–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç!');
      return;
    }
    let lines = ['–§–ò–û | –ö–ª–∞—Å—Å | –ü—Ä–µ–¥–º–µ—Ç | –û—Ü–µ–Ω–∫–∞'];
    for(let s of students) {
      lines.push(`${s.fio} | ${s.className} | ${s.subject} | ${s.grade}`);
    }
    const content = lines.join('\n');
    downloadFile('journal.txt', content, 'text/plain;charset=utf-8');
  }

  function downloadJournalCSV() {
    if(students.length === 0) {
      alert('–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç!');
      return;
    }
    let csv = '–§–ò–û,–ö–ª–∞—Å—Å,–ü—Ä–µ–¥–º–µ—Ç,–û—Ü–µ–Ω–∫–∞\n';
    for(let s of students) {
      let fio = `"${s.fio.replace(/"/g, '""')}"`;
      let className = `"${s.className.replace(/"/g, '""')}"`;
      let subject = `"${s.subject.replace(/"/g, '""')}"`;
      csv += `${fio},${className},${subject},${s.grade}\n`;
    }
    downloadFile('journal.csv', csv, 'text/csv;charset=utf-8');
  }

  function downloadJournalXLSX() {
    if(students.length === 0) {
      alert('–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç!');
      return;
    }
    let xml = `<?xml version="1.0"?>
    <Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
      xmlns:o="urn:schemas-microsoft-com:office:office"
      xmlns:x="urn:schemas-microsoft-com:office:excel"
      xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">
      <Worksheet ss:Name="–ñ—É—Ä–Ω–∞–ª">
        <Table>
          <Row>
            <Cell><Data ss:Type="String">–§–ò–û</Data></Cell>
            <Cell><Data ss:Type="String">–ö–ª–∞—Å—Å</Data></Cell>
            <Cell><Data ss:Type="String">–ü—Ä–µ–¥–º–µ—Ç</Data></Cell>
            <Cell><Data ss:Type="String">–û—Ü–µ–Ω–∫–∞</Data></Cell>
          </Row>`;
    for(let s of students) {
      xml += `<Row>
        <Cell><Data ss:Type="String">${s.fio}</Data></Cell>
        <Cell><Data ss:Type="String">${s.className}</Data></Cell>
        <Cell><Data ss:Type="String">${s.subject}</Data></Cell>
        <Cell><Data ss:Type="Number">${s.grade}</Data></Cell>
      </Row>`;
    }
    xml += `
        </Table>
      </Worksheet>
    </Workbook>`;
    downloadFile('journal.xls', xml, 'application/vnd.ms-excel;charset=utf-8');
  }

  function downloadFile(filename, content, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // --- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ---

  // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –º–µ–¥–∏–∞–Ω—ã
  function median(values) {
    if(values.length === 0) return 0;
    values.sort((a,b) => a - b);
    const mid = Math.floor(values.length / 2);
    if(values.length % 2 === 0) {
      return (values[mid - 1] + values[mid]) / 2;
    } else {
      return values[mid];
    }
  }

  // –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –º–∞—Å—Å–∏–≤—É –æ—Ü–µ–Ω–æ–∫
  // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç —Å avg, median, counts {1: n, 2: n, ...}, percents {1: %, ...}
  function getStats(grades) {
    if(grades.length === 0) return null;
    const counts = {1:0,2:0,3:0,4:0,5:0};
    grades.forEach(g => {
      if(counts[g] !== undefined) counts[g]++;
    });
    const total = grades.length;
    const avg = grades.reduce((a,b) => a+b,0) / total;
    const med = median(grades);
    const percents = {};
    for(let i=1; i<=5; i++) {
      percents[i] = ((counts[i]/total)*100).toFixed(1);
    }
    return {avg: avg.toFixed(2), median: med, counts, percents};
  }

  // –†–µ–Ω–¥–µ—Ä —Ç–∞–±–ª–∏—Ü—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
  function renderStatsTable(stats, title) {
    if(!stats) return `<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.</p>`;
    let html = `<h4>${escapeHTML(title)}</h4>`;
    html += `<table aria-label="${escapeHTML(title)}">
      <thead>
        <tr>
          <th>–û—Ü–µ–Ω–∫–∞</th><th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th><th>–ü—Ä–æ—Ü–µ–Ω—Ç (%)</th>
        </tr>
      </thead>
      <tbody>`;
    for(let i=1; i<=5; i++) {
      html += `<tr>
        <td>${i}</td>
        <td>${stats.counts[i]}</td>
        <td>${stats.percents[i]}</td>
      </tr>`;
    }
    html += `</tbody>
      <tfoot>
        <tr><td><strong>–°—Ä–µ–¥–Ω—è—è</strong></td><td colspan="2">${stats.avg}</td></tr>
        <tr><td><strong>–ú–µ–¥–∏–∞–Ω–∞</strong></td><td colspan="2">${stats.median}</td></tr>
      </tfoot>
    </table>`;
    return html;
  }

  // –†–µ–Ω–¥–µ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º
  function renderStats() {
    const statsClass = document.getElementById('statsClass').value;
    const statsSubject = document.getElementById('statsSubject').value;
    const output = document.getElementById('statsOutput');
    if(students.length === 0) {
      output.innerHTML = '<p>–î–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.</p>';
      return;
    }

    // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–ª–∞—Å—Å—É –∏ –ø—Ä–µ–¥–º–µ—Ç—É
    let filtered = students;
    if(statsClass !== 'all') filtered = filtered.filter(s => s.className === statsClass);
    if(statsSubject !== 'all') filtered = filtered.filter(s => s.subject === statsSubject);

    if(filtered.length === 0) {
      output.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤.</p>';
      return;
    }

    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –∫–ª–∞—Å—Å –∏ –ø—Ä–µ–¥–º–µ—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —ç—Ç–∏–º –¥–∞–Ω–Ω—ã–º
    if(statsClass !== 'all' && statsSubject !== 'all') {
      const grades = filtered.map(s => s.grade);
      const stats = getStats(grades);
      output.innerHTML = renderStatsTable(stats, `–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –∫–ª–∞—Å—Å–∞ ${statsClass} –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É ${statsSubject}`);
      return;
    }

    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –∫–ª–∞—Å—Å, –Ω–æ –ø—Ä–µ–¥–º–µ—Ç "–≤—Å–µ"
    if(statsClass !== 'all' && statsSubject === 'all') {
      // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞ –≤ —ç—Ç–æ–º –∫–ª–∞—Å—Å–µ –≤—ã–≤–æ–¥–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      const subjects = Array.from(new Set(filtered.map(s => s.subject))).sort();
      if(subjects.length === 0) {
        output.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞.</p>';
        return;
      }
      let html = '';
      subjects.forEach(subj => {
        const grades = filtered.filter(s => s.subject === subj).map(s => s.grade);
        const stats = getStats(grades);
        html += renderStatsTable(stats, `–ö–ª–∞—Å—Å ${statsClass}, –ø—Ä–µ–¥–º–µ—Ç ${subj}`);
      });
      output.innerHTML = html;
      return;
    }

    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –ø—Ä–µ–¥–º–µ—Ç, –Ω–æ –∫–ª–∞—Å—Å "–≤—Å–µ"
    if(statsClass === 'all' && statsSubject !== 'all') {
      // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∞—Å—Å–∞ –≤—ã–≤–æ–¥–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —ç—Ç–æ–º—É –ø—Ä–µ–¥–º–µ—Ç—É
      const classes = Array.from(new Set(filtered.map(s => s.className))).sort();
      if(classes.length === 0) {
        output.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞.</p>';
        return;
      }
      let html = '';
      classes.forEach(cls => {
        const grades = filtered.filter(s => s.className === cls).map(s => s.grade);
        const stats = getStats(grades);
        html += renderStatsTable(stats, `–ü—Ä–µ–¥–º–µ—Ç ${statsSubject}, –∫–ª–∞—Å—Å ${cls}`);
      });
      output.innerHTML = html;
      return;
    }

    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω—ã –≤—Å–µ –∫–ª–∞—Å—Å—ã –∏ –≤—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞–∂–¥–æ–º—É –ø—Ä–µ–¥–º–µ—Ç—É –ø–æ –≤—Å–µ–º –∫–ª–∞—Å—Å–∞–º
    if(statsClass === 'all' && statsSubject === 'all') {
      const subjects = Array.from(new Set(students.map(s => s.subject))).sort();
      if(subjects.length === 0) {
        output.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</p>';
        return;
      }
      let html = '';
      subjects.forEach(subj => {
        const grades = students.filter(s => s.subject === subj).map(s => s.grade);
        const stats = getStats(grades);
        html += renderStatsTable(stats, `–ü—Ä–µ–¥–º–µ—Ç ${subj} (–≤—Å–µ –∫–ª–∞—Å—Å—ã)`);
      });
      output.innerHTML = html;
      return;
    }
  }

  // --- –ì—Ä–∞—Ñ–∏–∫–∏ ---

  // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏
  function clearCharts() {
    chartInstances.forEach(chart => chart.destroy());
    chartInstances = [];
    document.getElementById('chartsContainer').innerHTML = '';
  }

  // –†–µ–Ω–¥–µ—Ä–∏–º –≥—Ä–∞—Ñ–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞
  function renderAllSubjectCharts() {
    clearCharts();
    if(students.length === 0) {
      document.getElementById('chartsContainer').innerHTML = '<p>–î–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.</p>';
      return;
    }
    // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
    const subjects = Array.from(new Set(students.map(s => s.subject))).sort();
    if(subjects.length === 0) {
      document.getElementById('chartsContainer').innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤.</p>';
      return;
    }
    const container = document.getElementById('chartsContainer');

    subjects.forEach(subj => {
      // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞ —Å–æ–±–∏—Ä–∞–µ–º —Å—Ä–µ–¥–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏ –∫–∞–∂–¥–æ–≥–æ —É—á–µ–Ω–∏–∫–∞ (—É—á–µ–Ω–∏–∫–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –ø–æ –§–ò–û+–∫–ª–∞—Å—Å)
      const studentsOfSubject = students.filter(s => s.subject === subj);
      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —É—á–µ–Ω–∏–∫—É (–§–ò–û + –∫–ª–∞—Å—Å)
      const studentMap = {};
      studentsOfSubject.forEach(s => {
        const key = `${s.fio} (${s.className})`;
        if(!studentMap[key]) studentMap[key] = [];
        studentMap[key].push(s.grade);
      });

      // –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞ –ø–æ —É—á–µ–Ω–∏–∫—É
      const labels = Object.keys(studentMap);
      const avgGrades = labels.map(key => {
        const grades = studentMap[key];
        const avg = grades.reduce((a,b) => a+b,0) / grades.length;
        return +avg.toFixed(2);
      });

      // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
      const chartDiv = document.createElement('div');
      chartDiv.className = 'chart-container';
      chartDiv.innerHTML = `<h4>–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞ –ø–æ —É—á–µ–Ω–∏–∫–∞–º: ${escapeHTML(subj)}</h4><canvas id="chart_${subj.replace(/\W/g,'_')}"></canvas>`;
      container.appendChild(chartDiv);

      const ctx = chartDiv.querySelector('canvas').getContext('2d');
      const chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: '–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞',
            data: avgGrades,
            backgroundColor: 'rgba(230, 126, 34, 0.7)',
            borderColor: 'rgba(230, 126, 34, 1)',
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: {
              min: 1,
              max: 5,
              ticks: {
                stepSize: 1
              },
              title: {
                display: true,
                text: '–û—Ü–µ–Ω–∫–∞'
              }
            },
            x: {
              title: {
                display: true,
                text: '–£—á–µ–Ω–∏–∫ (–§–ò–û –∏ –∫–ª–∞—Å—Å)'
              }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => `–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞: ${ctx.parsed.y}`
              }
            }
          },
          responsive: true,
          maintainAspectRatio: false
        }
      });
      chartInstances.push(chart);
    });
  }

  // --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–∞ –≤ —Ñ–∞–π–ª CSV ---
  function saveJournal() {
    if(students.length === 0) {
      alert('–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç!');
      return;
    }
    downloadJournalCSV();
  }

  // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
  updateFilters();
  renderUploadTable();
  renderJournalTable();

</script>


</body></html>